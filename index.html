<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>舞雲智網 - 智能報價單系統 v8.1</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap');
body { font-family: 'Noto Sans TC', sans-serif; }

/* --- 列印專用樣式 --- */
@media print {
    @page { size: A4; margin: 0; }
    body { margin: 0; padding: 0; background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .no-print { display: none !important; }
    .print-area { display: block !important; width: 210mm; height: 296mm; margin: 0 auto; page-break-after: avoid; position: relative; }
    .a4-paper { width: 100% !important; height: 100% !important; padding: 10mm 15mm !important; box-shadow: none !important; margin: 0 !important; display: flex !important; flex-direction: column !important; justify-content: space-between !important; }
    /* 隱藏捲軸與多餘元素 */
    ::-webkit-scrollbar { display: none; }
}

/* 螢幕顯示用的 A4 模擬 */
.a4-paper {
    width: 210mm;
    min-height: 297mm;
    background: white;
    margin: 0 auto;
    box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    padding: 15mm;
    position: relative;
    display: flex;
    flex-direction: column;
}

/* 表格樣式微調 */
.items-table th { background-color: #f3f4f6; border-bottom: 2px solid #e5e7eb; color: #374151; font-weight: 700; }
.items-table td { border-bottom: 1px solid #f3f4f6; }
</style>
</head>
<body class="bg-gray-100 text-gray-700">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;

// 1. 更新業務人員清單
const SALES_REPS = [
    '請選擇',
    '黃永裕 Eddy',
    '管翊揚 Yang',
    '林靜美 Shaders',
    '吳玥瑨 Yueh',
    '陳念慈 Nico',
    '李靜 Lidia'
];

const QuotationSystem = () => {
  
  // 輔助函數：取得初始資料
  const getInitialData = () => {
    const today = new Date().toISOString().split('T')[0];
    const validDate = new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    
    // 定義固定的備註文字
    const defaultRemarks = `匯款資訊： 兆豐國際商業銀行(017) 新竹分行 | 帳號：203-09-06002-1 | 戶名：舞雲智網股份有限公司
有效期限： 本報價單有效期限為 ${validDate}，逾期請重新詢價。`;

    return {
      customerName: 'ABC股份有限公司',
      customerTaxId: '12345678',
      projectName: '碳定價管理流程輔導',
      salesRep: SALES_REPS[0], // 預設為 "請選擇"
      quotationDate: today,
      validUntil: validDate,
      paymentTerms: '驗收後月結 30 天',
      customRemarks: defaultRemarks,
      items: [
        {
          id: '1',
          description: '碳定價管理流程輔導\n(說明)',
          unit: '人時',
          quantity: 100,
          unitPrice: 10000,
          remark: '顧問服務'
        }
      ]
    };
  };

  const [data, setData] = useState(getInitialData());
  const [showPreview, setShowPreview] = useState(false);

  // 重置表單功能
  const handleReset = () => {
    if (confirm('確定要開新報價單嗎？目前未儲存的內容將會消失，並回復至預設值。')) {
      setData(getInitialData());
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  };

  const handleChange = (field, value) => {
    setData(prev => ({ ...prev, [field]: value }));
  };

  const handleItemChange = (id, field, value) => {
    const newItems = data.items.map(item => 
      item.id === id ? { ...item, [field]: value } : item
    );
    setData(prev => ({ ...prev, items: newItems }));
  };

  const addItem = () => {
    const newItem = {
      id: Date.now().toString(),
      description: '',
      unit: '式',
      quantity: 1,
      unitPrice: 0,
      remark: ''
    };
    setData(prev => ({ ...prev, items: [...prev.items, newItem] }));
  };

  const removeItem = (id) => {
    setData(prev => ({ ...prev, items: prev.items.filter(item => item.id !== id) }));
  };

  // 金額計算
  const subtotal = data.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
  const tax = Math.round(subtotal * 0.05);
  const total = subtotal + tax;

  // 數字格式化 (千分位)
  const formatNumber = (num) => {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  };

  const handlePrint = () => {
    window.print();
  };

  return (
    <div className="min-h-screen pb-12">
      {/* --- 頂部導航列 --- */}
      <div className="no-print bg-white border-b border-gray-200 sticky top-0 z-50 shadow-sm">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="bg-blue-600 text-white w-8 h-8 rounded flex items-center justify-center">
              <i className="fas fa-calculator"></i>
            </div>
            <h1 className="text-xl font-bold text-gray-800">智能報價單系統 <span className="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded ml-2">v8.1</span></h1>
          </div>
          <div className="flex gap-3">
            <button 
              onClick={handleReset}
              className="px-4 py-2 bg-yellow-500 hover:bg-yellow-600 text-white rounded-lg text-sm font-bold shadow transition flex items-center gap-2"
            >
              <i className="fas fa-file-circle-plus"></i>
              新開報價單
            </button>
            <button 
              onClick={() => setShowPreview(!showPreview)}
              className="lg:hidden px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition flex items-center gap-2"
            >
              <i className={`fas ${showPreview ? 'fa-edit' : 'fa-eye'}`}></i>
              {showPreview ? '返回編輯' : '預覽'}
            </button>
            <button 
              onClick={handlePrint}
              className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-bold shadow-lg transition transform hover:-translate-y-0.5 flex items-center gap-2"
            >
              <i className="fas fa-print"></i>
              下載 PDF / 列印
            </button>
          </div>
        </div>
      </div>

      <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        {/* --- 左側：編輯區 (列印時隱藏) --- */}
        <div className={`lg:col-span-4 space-y-6 no-print ${showPreview ? 'hidden' : 'block'}`}>
          {/* 客戶資訊 */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span className="w-1 h-5 bg-blue-500 rounded-full"></span>
              客戶資訊
            </h2>
            <div className="space-y-3">
              <div>
                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">客戶名稱</label>
                <input type="text" value={data.customerName} onChange={(e) => handleChange('customerName', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              <div>
                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">統一編號</label>
                <input type="text" value={data.customerTaxId} onChange={(e) => handleChange('customerTaxId', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              <div>
                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">專案名稱</label>
                <input type="text" value={data.projectName} onChange={(e) => handleChange('projectName', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
              </div>
              {/* 經辦人員下拉選單 */}
              <div>
                <label className="block text-xs font-bold text-gray-500 mb-1 uppercase text-blue-600">經辦人員 (業務姓名)</label>
                <div className="relative">
                    <select 
                        value={data.salesRep} 
                        onChange={(e) => handleChange('salesRep', e.target.value)} 
                        className="w-full px-3 py-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-blue-50 appearance-none cursor-pointer"
                    >
                        {SALES_REPS.map(rep => (
                            <option key={rep} value={rep}>{rep}</option>
                        ))}
                    </select>
                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-blue-600">
                        <i className="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">報價日期</label>
                  <input type="date" value={data.quotationDate} onChange={(e) => handleChange('quotationDate', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                </div>
                <div>
                  <label className="block text-xs font-bold text-gray-500 mb-1 uppercase">有效期限</label>
                  <input type="date" value={data.validUntil} onChange={(e) => handleChange('validUntil', e.target.value)} className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                </div>
              </div>
            </div>
          </div>

          {/* 報價品項編輯 */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
            <h2 className="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
              <span className="w-1 h-5 bg-green-500 rounded-full"></span>
              報價品項
            </h2>
            <div className="space-y-4">
              {data.items.map((item, idx) =>
